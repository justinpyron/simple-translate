name: Build and Push Docker Image

on:
  workflow_dispatch:

env:
  GAR_LOCATION: ${{ vars.GAR_LOCATION }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  SERVER_URL: ${{ vars.SERVER_URL }}

jobs:
  build-and-push-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          pip install poetry poetry-plugin-export
          poetry --version

      - name: Export requirements from Poetry
        run: |
          poetry export --only main -f requirements.txt --output requirements.txt --without-hashes
          echo "Generated requirements.txt:"
          cat requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # Generate image tags (outputs full image references, not just tag names)
      # Example output: us-central1-docker.pkg.dev/PROJECT/REPO/IMAGE:TAG
      # Creates 3 tags:
      #   1. Commit SHA (e.g., main-abc123) - for pinning to specific commits
      #   2. Branch name (e.g., main) - tracks latest build on branch
      #   3. 'latest' tag - only on default branch
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
